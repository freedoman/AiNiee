# 位置映射系统 - 图解说明

## 📊 数据流程对比

```
旧方案（混合标记）：
┌──────────────────────────────────────────────────────────┐
│ Word文档                                                 │
│ ┌──────────────────────────────────────────────┐        │
│ │ "世界" (加粗) + "卫生" (斜体) + "组织" (红色) │        │
│ └──────────────────────────────────────────────┘        │
└──────────────────────────────────────────────────────────┘
                    ↓ 插入标记
┌──────────────────────────────────────────────────────────┐
│ 带标记的文本                                             │
│ "<RUNBND1>世界<RUNBND2>卫生<RUNBND3>组织<RUNBND4>"      │
└──────────────────────────────────────────────────────────┘
                    ↓ 给LLM翻译
┌──────────────────────────────────────────────────────────┐
│ LLM处理                                                  │
│ ❌ 问题：                                                │
│   - 标记和文本混在一起                                   │
│   - 可能丢失标记（如末尾的RUNBND4）                      │
│   - 调整语序时标记跟着移动，顺序错乱                     │
└──────────────────────────────────────────────────────────┘
                    ↓ 翻译结果
┌──────────────────────────────────────────────────────────┐
│ 可能有问题的译文                                         │
│ "Всемирная<RUNBND2> организация<RUNBND3>..." ← 丢了RUNBND1!│
└──────────────────────────────────────────────────────────┘




新方案（位置映射）：
┌──────────────────────────────────────────────────────────┐
│ Word文档                                                 │
│ ┌──────────────────────────────────────────────┐        │
│ │ "世界" (加粗) + "卫生" (斜体) + "组织" (红色) │        │
│ └──────────────────────────────────────────────┘        │
└──────────────────────────────────────────────────────────┘
                    ↓ 分离提取
┌─────────────────────────────┐  ┌──────────────────────────┐
│ 文本层（纯文本）             │  │ 格式层（位置+样式）       │
│ "世界卫生组织"               │  │ [0:2] → bold             │
│                              │  │ [2:4] → italic           │
│                              │  │ [4:6] → red              │
└─────────────────────────────┘  └──────────────────────────┘
         ↓ 只给LLM文本                    ↓ 保留格式信息
┌──────────────────────────────────────────────────────────┐
│ LLM处理                                                  │
│ ✅ 优势：                                                │
│   - 只看到纯文本"世界卫生组织"                           │
│   - 不会被标记干扰                                       │
│   - 翻译质量更高                                         │
└──────────────────────────────────────────────────────────┘
         ↓ 翻译结果
┌─────────────────────────────┐
│ 译文纯文本                   │
│ "Всемирная организация       │
│  здравоохранения"            │
└─────────────────────────────┘
         ↓ 词对齐
┌──────────────────────────────────────────────────────────┐
│ 词对齐（找到原文和译文的对应关系）                       │
│ "世界" [0:2]  → "Всемирная" [0:10]                      │
│ "卫生" [2:4]  → "организация" [11:22]                   │
│ "组织" [4:6]  → "здравоохранения" [23:38]               │
└──────────────────────────────────────────────────────────┘
         ↓ 格式映射
┌─────────────────────────────┐  ┌──────────────────────────┐
│ 译文纯文本                   │  │ 译文格式（自动计算）     │
│ "Всемирная организация       │  │ [0:10] → bold            │
│  здравоохранения"            │  │ [11:22] → italic         │
│                              │  │ [23:38] → red            │
└─────────────────────────────┘  └──────────────────────────┘
         ↓ 合并应用
┌──────────────────────────────────────────────────────────┐
│ Word文档输出                                             │
│ ┌────────────────────────────────────────────────┐      │
│ │ "Всемирная" (加粗) + "организация" (斜体) +    │      │
│ │ "здравоохранения" (红色)                       │      │
│ └────────────────────────────────────────────────┘      │
│ ✅ 完美！所有格式都正确应用                              │
└──────────────────────────────────────────────────────────┘
```

---

## 🔍 词对齐详解

### 什么是词对齐？

就像在原文和译文之间画线，连接对应的词：

```
原文：  世界      卫生      组织
        │        │        │
        ├────────┤        │
        │        ├────────┤
        │        │        │
译文：Всемирная организация здравоохранения
     (世界的)   (组织)    (健康保护的)
```

### 对齐方法

#### 方法1：位置比例（简单粗暴）
```python
# 假设翻译是线性的
原文长度: 6个字符
译文长度: 38个字符

原文"世界"在位置[0:2] (占0-33%)
↓
译文对应位置[0:12] (38 * 33% ≈ 12)
```

**优点**：简单快速，无需额外工具  
**缺点**：语序变化大时不准确

#### 方法2：统计对齐（智能）
```python
# 使用BERT等模型计算语义相似度
from simalign import SentenceAligner

aligner = SentenceAligner()
alignments = aligner.get_word_aligns(
    "世界卫生组织",
    "Всемирная организация здравоохранения"
)

# 结果：
# "世界" ←→ "Всемирная" (相似度: 0.95)
# "卫生" ←→ "организация" (相似度: 0.82)
# "组织" ←→ "здравоохранения" (相似度: 0.88)
```

**优点**：处理语序变化准确  
**缺点**：需要安装库，速度较慢

#### 方法3：混合策略（推荐）
```
1. 专有名词优先（WHO, HIV, DOTS等）
   → 直接匹配，100%准确
   
2. 数字和标点
   → 简单匹配，准确率高
   
3. 普通词汇
   → 使用统计对齐
   
4. 实在找不到
   → 回退到位置比例
```

---

## 💡 核心优势总结

### 1. 彻底解决标记问题

```
旧方案：
  问题：LLM翻译 "<RUNBND1>WHO<RUNBND2>" → "ВОЗ" (丢失标记)
  
新方案：
  LLM翻译 "WHO" → "ВОЗ"
  格式：[0:3] bold → 自动映射到 [0:3] bold
  结果：永远不会丢失！
```

### 2. 翻译质量提升

```
旧方案：
  LLM看到：<RUNBND1>耐多药<RUNBND2>/<RUNBND3>利福平<RUNBND4>
  困惑：这些<RUNBND>是什么？要翻译吗？
  
新方案：
  LLM看到：耐多药/利福平
  清晰：只需要翻译这些词
  结果：翻译更准确自然
```

### 3. 维护成本降低

```
旧方案：
  - 不断调整Prompt提醒LLM保留标记
  - 每次出错都要手动修复
  - 复杂的错误检测逻辑
  
新方案：
  - 格式映射逻辑独立
  - 可以单独测试和优化
  - 代码结构清晰
```

---

## 📈 实施难度评估

### 需要修改的模块

```
1. FileReader (Word读取)         难度：★★★☆☆
   - 提取纯文本
   - 提取格式信息（run的bold、italic等）
   - 记录每个run的位置

2. TaskExecutor (翻译流程)       难度：★★☆☆☆
   - 传递纯文本给LLM
   - 保存格式映射表

3. PositionMapper (新增)         难度：★★★★☆
   - 实现词对齐算法
   - 格式映射计算
   
4. FileOutputer (Word写入)       难度：★★★☆☆
   - 根据格式映射应用样式
   - 重建Word文档的run结构
```

### 工作量估算

```
- 基础版（位置比例）：  3-5天
- 完整版（统计对齐）：  1-2周
- 优化版（混合策略）：  2-3周
```

---

## 🚀 迁移路径

### 阶段1：兼容模式（推荐）

```python
# 同时支持两种模式
class TranslationEngine:
    def __init__(self, mode="auto"):
        self.mode = mode  # "legacy" | "position_mapping" | "auto"
    
    def translate(self, document):
        if self.mode == "legacy":
            # 使用旧的标记方案
            return self.translate_with_markers(document)
        elif self.mode == "position_mapping":
            # 使用新的位置映射
            return self.translate_with_mapping(document)
        else:
            # 自动选择：根据文档复杂度
            if self.is_complex(document):
                return self.translate_with_mapping(document)
            else:
                return self.translate_with_markers(document)
```

### 阶段2：逐步切换

```
Week 1-2: 实现位置映射原型
Week 3:   小规模测试（10-20个文档）
Week 4:   对比测试（旧方案 vs 新方案）
Week 5:   用户反馈收集
Week 6:   根据反馈优化
Week 7+:  逐步设为默认方案
```

---

## ❓ 常见问题

### Q1: 词对齐不准确怎么办？

**答**：使用多级回退策略
```
1. 优先匹配专有名词（准确率~100%）
2. 其次使用统计对齐（准确率~90%）
3. 最后使用位置比例（准确率~70%）

平均准确率：~90%
```

### Q2: 性能会变慢吗？

**答**：略慢，但可接受
```
旧方案：100ms/段落
新方案：150ms/段落（增加50%）

但考虑到：
- 不需要重试（减少LLM调用）
- 翻译质量提升（减少人工修正）
总体效率反而更高
```

### Q3: 兼容性如何？

**答**：完全兼容
```
- 可以读取旧方案翻译的文档
- 可以输出给不支持新方案的系统
- 通过转换器实现双向兼容
```

---

## 📚 参考资料

### 词对齐算法论文
- SimAlign: "SimAlign: High Quality Word Alignments without Parallel Training Data using Static and Contextualized Embeddings"
- Awesome-align: "Awesome Align: A Robust Self-Supervised Word Alignment Framework"

### Python库
```bash
# 轻量级对齐
pip install simalign

# 高质量对齐（需要GPU）
pip install awesome-align

# 统计对齐（传统方法）
pip install fast-align
```

### 示例代码仓库
- 我已经创建的原型：`BoundaryMarkerAlternative/`
  - `position_mapper.py` - 位置映射核心逻辑
  - `marker_fixer.py` - 临时修复方案
  - `detailed_explanation.py` - 详细演示
